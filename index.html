<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8">
<title>Living Energy Particles FINAL v4</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<style>
html,body{margin:0;overflow:hidden;background:#050814}
canvas{display:block}
#ui{
 position:fixed;left:14px;top:14px;
 width:210px;padding:12px;
 background:rgba(18,22,55,.55);
 backdrop-filter:blur(14px);
 border-radius:14px;
 color:#fff;font-family:system-ui;font-size:12px
}
label{display:block;margin-top:8px}
input,select,button{width:100%}
button{margin-top:10px}
video{display:none}
</style>
</head>
<body>

<div id="ui">
<label>模型</label>
<select id="shape">
<option value="galaxy">银河</option>
<option value="heart">爱心</option>
<option value="flower">花朵</option>
<option value="firework">烟花</option>
</select>
<label>粒子大小</label>
<input id="size" type="range" min="0.4" max="2" step="0.1" value="0.8">
<label>粒子密度</label>
<input id="density" type="range" min="3000" max="12000" step="500" value="6000">
<button id="fullscreen">全屏</button>
</div>

<video id="video" playsinline></video>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
/* ================= SCENE ================= */
const scene=new THREE.Scene();
scene.fog=new THREE.Fog(0x06091c,150,900);

const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,.1,1600);
camera.position.z=420;

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(devicePixelRatio);
renderer.setClearColor(0x050814);
document.body.appendChild(renderer.domElement);

addEventListener('resize',()=>{
 camera.aspect=innerWidth/innerHeight;
 camera.updateProjectionMatrix();
 renderer.setSize(innerWidth,innerHeight);
});

/* ================= BACKGROUND ================= */
const bgHalo=new THREE.Mesh(
 new THREE.SphereGeometry(900,64,64),
 new THREE.MeshBasicMaterial({
  color:0x6677ff,
  transparent:true,
  opacity:.2,
  side:THREE.BackSide
 })
);
scene.add(bgHalo);

/* ================= GROUP ================= */
const group=new THREE.Group();
scene.add(group);

/* ================= GEOMETRY ================= */
const geoSphere=new THREE.SphereGeometry(0.25,10,10);
const geoBox=new THREE.BoxGeometry(0.35,0.35,0.35);
const geoTri=new THREE.ConeGeometry(0.3,0.45,3);
const geos=[geoSphere,geoBox,geoTri];

let COUNT=6000; // 密度 +0.2 倍
let particles=[],target=[];

/* ================= GLOW ================= */
const glowCanvas=document.createElement('canvas');
glowCanvas.width=64;glowCanvas.height=64;
const gctx=glowCanvas.getContext('2d');
const grad=gctx.createRadialGradient(32,32,0,32,32,32);
grad.addColorStop(0,'rgba(255,255,255,.7)');     // 发光 +0.5 倍
grad.addColorStop(.4,'rgba(255,255,255,.3)');
grad.addColorStop(1,'rgba(255,255,255,0)');
gctx.fillStyle=grad;
gctx.fillRect(0,0,64,64);
const glowTex=new THREE.CanvasTexture(glowCanvas);

/* ================= BUILD ================= */
function build(){
 group.clear();particles=[];target=[];
 for(let i=0;i<COUNT;i++){
  const color=new THREE.Color().setHSL(Math.random(),.75,.6);
  const mat=new THREE.MeshStandardMaterial({
   color:color.clone().multiplyScalar(.5),
   emissive:color.clone().multiplyScalar(1.2), // 发光增强
   roughness:.45,metalness:.1
  });
  const mesh=new THREE.Mesh(geos[i%3],mat);

  const halo=new THREE.Sprite(new THREE.SpriteMaterial({
   map:glowTex,color,transparent:true,
   opacity:.35,blending:THREE.AdditiveBlending,depthWrite:false
  }));
  halo.scale.set(5,5,1);
  mesh.add(halo);

  const bubbleGeo=new THREE.SphereGeometry(0.12,6,6);
  const bubbles=[];
  for(let j=0;j<3;j++){
   const b=new THREE.Mesh(
    bubbleGeo,
    new THREE.MeshBasicMaterial({
     color:color.clone().multiplyScalar(1.4),
     transparent:true,opacity:.35
    })
   );
   b.userData={angle:Math.random()*Math.PI*2,speed:0.01+Math.random()*0.01,radius:0.8+Math.random()*0.4};
   mesh.add(b);
   bubbles.push(b);
  }

  mesh.userData={bubbles};
  mesh.position.set((Math.random()-.5)*260,(Math.random()-.5)*260,(Math.random()-.5)*260);

  const s=(.2+Math.random()*0.4)*2; 
  mesh.scale.setScalar(s);

  group.add(mesh);
  particles.push({m:mesh,h:halo,phase:Math.random()*6.28});
  target.push({x:0,y:0,z:0});
 }
}

/* ================= MODELS ================= */
const models={
 galaxy(){
  target.forEach(t=>{
   const a=Math.random()*Math.PI*6;
   const r=Math.random()**.5*190; // 整体扩大 0.5 倍
   t.x=Math.cos(a)*r;
   t.z=Math.sin(a)*r;
   t.y=(Math.random()-.5)*120;
  });
 },
 heart(){
  target.forEach(t=>{
   const a=Math.random()*6.28,r=Math.random()**.6;
   t.x=16*Math.sin(a)**3*r*7.5;
   t.y=-(13*Math.cos(a)-5*Math.cos(2*a))*r*7.5;
   t.z=(Math.random()-.5)*90;
  });
 },
 flower(){
  target.forEach(t=>{
   const a=Math.random()*6.28;
   const r=(Math.sin(6*a)+1.5)*Math.random()*135;
   t.x=Math.cos(a)*r;
   t.y=Math.sin(a)*r;
   t.z=(Math.random()-.5)*120;
  });
 },
 firework(){
  target.forEach(t=>{
   const a=Math.random()*6.28;
   const b=Math.acos(2*Math.random()-1);
   const r=240;
   t.x=r*Math.sin(b)*Math.cos(a);
   t.y=r*Math.cos(b);
   t.z=r*Math.sin(b)*Math.sin(a);
  });
 }
};

/* ================= HEART CORE ================= */
const heartCore=new THREE.Group();
group.add(heartCore);
const heartParticles=[];
for(let i=0;i<200;i++){
 const geo=new THREE.SphereGeometry(0.2,8,8);
 const mat=new THREE.MeshBasicMaterial({color:0xff5577});
 const m=new THREE.Mesh(geo,mat);
 heartCore.add(m);
 heartParticles.push(m);
}
function heartShape(){
 heartParticles.forEach(p=>{
  const a=Math.random()*6.28;
  const r=Math.random()**.6;
  p.position.set(
   16*Math.sin(a)**3*r*2.4,
   -(13*Math.cos(a)-5*Math.cos(2*a))*r*2.4,
   (Math.random()-.5)*8
  );
 });
}
heartShape();

/* ================= HAND ================= */
let hx=0,hy=0,scaleT=1;
const hands=new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
hands.setOptions({maxNumHands:1,modelComplexity:1,minDetectionConfidence:.75,minTrackingConfidence:.75});
hands.onResults(r=>{
 if(!r.multiHandLandmarks)return;
 const lm=r.multiHandLandmarks[0];
 const palm=lm[9];
 const t=lm[4],i=lm[8];
 hx=(palm.x-.5)*2;
 hy=(.5-palm.y)*2;
 const d=Math.hypot(t.x-i.x,t.y-i.y);
 scaleT=THREE.MathUtils.clamp(.5+d*8,.4,5);
});
new Camera(video,{onFrame:async()=>hands.send({image:video}),width:640,height:480}).start();

/* ================= UI ================= */
shape.onchange=e=>models[e.target.value]();
size.oninput=e=>particles.forEach(p=>{
 p.m.scale.setScalar(e.target.value*(.6+Math.random())*2);
});
density.onchange=e=>{
 COUNT=parseInt(e.target.value);
 build();models.galaxy();
};
fullscreen.onclick=()=>document.fullscreenElement?document.exitFullscreen():document.body.requestFullscreen();

/* ================= LIGHT ================= */
scene.add(new THREE.AmbientLight(0xffffff,.5));
const dir=new THREE.DirectionalLight(0xffffff,.7);
dir.position.set(1,1,1);
scene.add(dir);

/* ================= START ================= */
build();models.galaxy();

/* ================= COLOR CHANGE ================= */
setInterval(()=>{
 particles.forEach(p=>{
  const c=new THREE.Color().setHSL(Math.random(),.75,.6);
  p.m.material.color.copy(c.clone().multiplyScalar(.5));
  p.m.material.emissive.copy(c.clone().multiplyScalar(1.2));
  p.h.material.color.copy(c);
 });
},5000);

/* ================= ANIMATE ================= */
let t=0,scale=1,rotX=0,rotY=0;
function animate(){
 requestAnimationFrame(animate);
 t+=.01;

 rotY+=(hx*.06-rotY)*.12;
 rotX+=(hy*.06-rotX)*.12;
 group.rotation.y+=rotY+0.00004;
 group.rotation.x+=rotX;

 scale+=(scaleT-scale)*.15;
 group.scale.setScalar(scale*1.5); // 整体再放大 0.5 倍

 group.position.x=THREE.MathUtils.clamp(hx*150,-150,150);
 group.position.y=THREE.MathUtils.clamp(hy*120,-120,120);

 particles.forEach((p,i)=>{
  const tg=target[i];
  const breath=1+.14*Math.sin(t+p.phase);
  p.m.position.x+=(tg.x*breath-p.m.position.x)*.04;
  p.m.position.y+=(tg.y*breath-p.m.position.y)*.04;
  p.m.position.z+=(tg.z*breath-p.m.position.z)*.04;

  p.h.material.opacity=.25+.15*Math.sin(t*1.4+p.phase);

  p.m.userData.bubbles.forEach(b=>{
   b.userData.angle+=b.userData.speed;
   b.position.set(
    Math.cos(b.userData.angle)*b.userData.radius,
    Math.sin(b.userData.angle*.7)*b.userData.radius,
    Math.sin(b.userData.angle)*b.userData.radius
   );
  });
 });

 const beat=1+0.18*Math.sin(t*3);
 heartCore.scale.setScalar(beat);

 bgHalo.material.opacity=.18+.06*Math.sin(t*.7);
 renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>

